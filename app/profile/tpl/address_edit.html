<div class="site__body">
    <div class="block-space block-space--layout--after-header"></div>
    <div class="block">
        <div class="container container--max--xl">
            <div class="row">
                <div class="col-12 col-lg-3 d-flex">
                    {PROFILE_MENU}
                </div>
                <div class="col-12 col-lg-9 mt-4 mt-lg-0">
                    <div class="card">
                        <div class="card-header">
                            <h5><lang id='PROFILE_EDIT_ADDRESS_L1'>Edit Address</lang></h5>
                        </div>
                        <div class="card-divider"></div>
                        <div class="card-body card-body--padding--2">
                            <div class="row no-gutters">
                                <div class="col-12 col-lg-10 col-xl-8">
                                    <form id="addressForm">

                                        <input type="hidden" name="recId" value="{REC_ID}">

                                        <div class="form-row">
                                            <div class="form-group col-md-6">
                                                <label for="address-first-name"><lang id='PROFILE_EDIT_ADDRESS_L2'>First Name</lang></label>
                                                <input type="text" name="name" class="form-control" id="address-first-name" placeholder="<lang id='PROFILE_EDIT_ADDRESS_L2'>First name</lang>" value="{NAME}">
                                                <em class="invalid-feedback"></em>
                                            </div>
                                            <div class="form-group col-md-6">
                                                <label for="address-last-name"><lang id='PROFILE_EDIT_ADDRESS_L3'>Last Name</lang></label>
                                                <input type="text" name="surname" class="form-control" id="address-last-name" placeholder="<lang id='PROFILE_EDIT_ADDRESS_L3'>Last name</lang>" value="{SURNAME}">
                                                <em class="invalid-feedback"></em>
                                            </div>
                                        </div>
                                       

                                        <div class="form-group">
                                            <label for="address-country"><lang id='PROFILE_EDIT_ADDRESS_L4'>Shipping Country</lang></label>
                                            <select id="address-country" class="form-control" name="country">
                                                {COUNTRY_LIST}
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label for="shippingAddress"><lang id='PROFILE_EDIT_ADDRESS_L5'>Shipping address</lang></label>
                                            <input type="text" class="form-control" id="shippingAddress" placeholder="<lang id='PROFILE_EDIT_ADDRESS_L5'>Shipping address</lang>" name="shippingAddress" value="{SHIPPING_ADDRESS}">
                                            <em class="invalid-feedback"></em>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="address-city"><lang id='PROFILE_EDIT_ADDRESS_L6'>Town / City</lang></label>
                                            <input type="text" class="form-control" id="address-city" name="city" placeholder="<lang id='PROFILE_EDIT_ADDRESS_L6'>Town / City</lang>" value="{CITY}">
                                            <em class="invalid-feedback"></em>
                                        </div>
                                        <div class="form-group">
                                            <label for="address-state"><lang id='PROFILE_EDIT_ADDRESS_L7'>State</lang></label>
                                            <input type="text" class="form-control" id="address-state" name="state" placeholder="<lang id='PROFILE_EDIT_ADDRESS_L7'>State</lang>" value="{STATE}">
                                            <em class="invalid-feedback"></em>
                                        </div>
                                        <div class="form-group">
                                            <label for="address-postcode"><lang id='PROFILE_EDIT_ADDRESS_L8'>Postcode / ZIP</lang></label>
                                            <input type="text" class="form-control" id="address-postcode" name="zip" placeholder="<lang id='PROFILE_EDIT_ADDRESS_L8'>Postcode / ZIP</lang>" value="{ZIP}">
                                            <em class="invalid-feedback"></em>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group col-md-6 mb-0">
                                                <label for="address-email"><lang id='PROFILE_EDIT_ADDRESS_L9'>Email address</lang></label>
                                                <input type="email" class="form-control" id="address-email" name="email" placeholder="<lang id='PROFILE_EDIT_ADDRESS_L9'>Email address</lang>" value="{EMAIL}">
                                                <em class="invalid-feedback"></em>
                                            </div>
                                            <div class="form-group col-md-6 mb-0">
                                                <label for="address-phone"><lang id='PROFILE_EDIT_ADDRESS_L10'>Phone Number</lang></label>
                                                <input type="text" class="form-control" id="address-phone" name="phone" placeholder="<lang id='PROFILE_EDIT_ADDRESS_L10'>Phone Number</lang>" value="{PHONE}">
                                                <em class="invalid-feedback"></em>
                                            </div>
                                        </div>
                                        <div class="form-group mt-3">
                                            <div class="form-check">
                                                <span class="input-check form-check-input">
                                                    <span class="input-check__body">
                                                        <input class="input-check__input" type="checkbox" id="default-address" name="is_default" <?php echo $IS_DEFAULT ? 'checked' : '' ?>>
                                                        <span class="input-check__box"></span>
                                                        <span class="input-check__icon">
                                                            <svg width="9px" height="7px">
                                                                <path
                                                                    d="M9,1.395L3.46,7L0,3.5L1.383,2.095L3.46,4.2L7.617,0L9,1.395Z">
                                                                </path>
                                                            </svg>
                                                        </span>
                                                    </span>
                                                </span>
                                                <label class="form-check-label" for="default-address"><lang id='PROFILE_EDIT_ADDRESS_L11'>Set as my default address</lang></label>
                                            </div>
                                        </div>
                                        <div class="form-group mb-0 pt-3 mt-3">
                                            <button type="submit" class="btn btn-primary"><lang id='PROFILE_EDIT_ADDRESS_L12'>Save</lang></button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="block-space block-space--layout--before-footer"></div>
</div>


<script>
    $(function(){

        jQuery.validator.addMethod("checkVatNumber", function(value, element) {
            var isSuccess = false;
            if(value == ""){
                $('#company').removeAttr('readonly');
                $('#address').removeAttr('readonly');
                return true;
            }

            $('#company').val('');
            $.ajax({
                url: '<?php echo $this->urlFor("ajax/home/chack_vat_number") ?>',
                data: {vatNumber: value},
                type: 'POST',
                async: false,
                success: function(data){
                    if(data.success){
                        if(data.data.valid){
                            $('#company').val(data.data.name);
                            $('#company').attr('readonly', true);
                            $('#address').val(data.data.address);
                            $('#address').attr('readonly', true);
                            isSuccess = true;
                        } else {
                            isSuccess = false;
                        }
                    } else {
                        isSuccess = false;
                    }
                }
            })
            return isSuccess;
        }, "<lang id='PROFILE_EDIT_ADDRESS_L13'>Incorrect VAT number</lang>");

        $("#addressForm").validate({
            "submitHandler": function (form) {
                $.ajax({
                    url: '<?php echo $this->urlFor("ajax/profile/save_edit_address") ?>',
                    type: 'POST',
                    dataType: 'JSON',
                    data: $('#addressForm').serialize(),
                    success: function(data){
                        if(data.success){
                            location.href = data.url; 
                        } else {
                            Swal.fire(
                                'Error',
                                'System error (Code: ' + data.error + ')',
                                'error'
                            )
                        }
                    }
                })
            },
            rules: {
                name: {
                    required: true,
                },
                surname: {
                    required: true,
                },
                companyVat: {
                    checkVatNumber: true,
                },
                country: {
                    required: true,
                },
                shippingAddress: {
                    required: true,
                },
                city: {
                    required: true,
                },
                state: {
                    required: true,
                },
                zip: {
                    required: true,
                },
                email: {
                    required: true,
                    email: true,
                },
                phone: {
                    required: true,
                },
            },
            
            onfocusout: function(element) {
                this.element(element);
            },
            "errorPlacement": function (error, element) {
                error.appendTo(element.parent().find("em"));
            },
            errorClass: 'is-invalid',
            validClass: '',
        });
    });


</script>